"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const web_service_interface_1 = require("@sirensolutions/web-service-interface");
const axios_1 = require("axios");
const cryptoRegexPatterns = {
    'BTC': '^(bc1|[13])[a-zA-HJ-NP-Z0-9]{25,39}$',
    'ETH': '^(?:0x)?[a-fA-F0-9]{40,42}$',
    'USDT': '^1[1-9][a-zA-Z0-9]{24,33}$',
    'XRP': '^r[0-9a-zA-Z]{24,34}$',
    'BNB': '^bnb[0-9a-zA-Z]{38}$',
    'ADA': '^Ae2tdPwUPEYy{44}$',
    'SOL': '^So[1-9][0-9a-zA-Z]{48}$',
    'DOGE': '^D[0-9a-fA-F]{32}$',
    'TRX': '^T[0-9a-fA-F]{33}$',
    'LTC': '^L[a-km-zA-HJ-NP-Z1-9]{26,33}$',
    'DOT': '^1[a-zA-Z0-9]{31}$',
    'LINK': '^0x[a-fA-F0-9]{40}$',
    'XLM': '^G[A-Z0-9]{55}$',
    'XMR': '^4[0-9A-Za-z]{94}$',
    'ATOM': '^cosmos1[a-z0-9]{38}$',
};
class AddressTransactions extends web_service_interface_1.ServiceDefinition {
    constructor() {
        super(...arguments);
        this.name = 'address_transactions';
        this.inputSchema = {
            address: { type: 'text', required: true },
            asset: { type: 'text', required: false },
            direction: { type: 'text', required: false },
            page: { type: 'text', required: false },
            page_limit: { type: 'float', required: false },
            cluster: { type: 'text', required: false },
            cluster_counterparty: { type: 'text', required: false },
            cluster_startTime: { type: 'text', required: false },
            cluster_endTime: { type: 'text', required: false },
        };
        this.outputConfiguration = {
            transaction: {
                details: {
                    'blockTimestamp': 'date',
                    'blockHeight': 'long',
                    'exchangeRate': 'long',
                    'fee': 'long',
                    traces: {
                        inputs: {
                            'amount': 'long'
                        },
                        outputs: {
                            'amount': 'long'
                        }
                    }
                }
            },
            pagination: {}
        };
    }
    inferAssetType(address) {
        return Object.keys(cryptoRegexPatterns).filter(asset => {
            return new RegExp(cryptoRegexPatterns[asset]).test(address);
        });
    }
    async invoke(inputs) {
        const matchedAssets = inputs.asset ? [inputs.asset] : this.inferAssetType(inputs.address);
        let overallResults = [];
        let overallNextPage = '';
        let overallTruncated = false;
        for (const asset of matchedAssets) {
            let base_url = inputs.cluster
                ? `https://iapi.chainalysis.com/clusters/${inputs.address}/${asset}/transactions?size=100`
                : `https://iapi.chainalysis.com/addresses/${inputs.address}/${asset}/transactions?size=100&direction=${inputs.direction}`;
            if (inputs.cluster_startTime) {
                base_url = base_url + `&startTime=${inputs.cluster_startTime}`;
            }
            if (inputs.cluster_endTime) {
                base_url = base_url + `&endTime=${inputs.cluster_endTime}`;
            }
            if (inputs.cluster_counterparty) {
                base_url = base_url + `&counterparty=${inputs.cluster_counterparty}`;
            }
            let transaction_url = `${base_url}`;
            if (inputs.page) {
                transaction_url = transaction_url + `&page=${inputs.page}`;
            }
            let pagesFetched = 0;
            const pageLimit = inputs.page_limit ? (inputs.page_limit === 0 ? Number.MAX_SAFE_INTEGER : inputs.page_limit) : Number.MAX_SAFE_INTEGER;
            const transaction_config = {
                method: 'get',
                url: transaction_url,
                headers: {
                    'Accept': 'application/json',
                    'token': this.config.token
                }
            };
            const transaction_response = await axios_1.default(transaction_config).catch(err => Promise.reject(err.response && err.response.status < 500 ? new web_service_interface_1.WebServiceError(err.response.data) : err));
            if (transaction_response.data.nextPage != null) {
                let page = transaction_response.data.nextPage;
                let lastResult = { nextPage: '' };
                do {
                    let sub_url = `${base_url}` + `&page=${page}`;
                    const sub_config = {
                        method: 'get',
                        url: sub_url,
                        headers: {
                            'Accept': 'application/json',
                            'token': this.config.token
                        }
                    };
                    const sub_response = await axios_1.default(sub_config).catch(err => Promise.reject(err.response && err.response.status < 500 ? new web_service_interface_1.WebServiceError(err.response.data) : err));
                    lastResult = sub_response.data;
                    transaction_response.data.items.push.apply(transaction_response.data.items, sub_response.data.items);
                    page = lastResult.nextPage;
                    pagesFetched += 1;
                } while (lastResult.nextPage !== null && pagesFetched < pageLimit);
                if (lastResult.nextPage !== null) {
                    overallTruncated = true;
                    overallNextPage = lastResult.nextPage;
                }
            }
            for (let y = 0; y < transaction_response.data.items.length; y++) {
                let hash_url = `https://iapi.chainalysis.com/transactions/${transaction_response.data.items[y].transactionHash}/${asset}/details`;
                const hash_config = {
                    method: 'get',
                    url: hash_url,
                    headers: {
                        'Accept': 'application/json',
                        'token': this.config.token
                    }
                };
                const hash_response = await axios_1.default(hash_config).catch(err => Promise.reject(err.response && err.response.status < 500 ? new web_service_interface_1.WebServiceError(err.response.data) : err));
                Object.assign(transaction_response.data.items[y], {
                    details: hash_response.data,
                    direction: inputs.direction,
                    id: asset + ':' + transaction_response.data.items[y].transactionHash,
                    sirenDenormInputAddress: [],
                    sirenDenormOutputAddress: []
                });
                try {
                    for (let a = 0; a < hash_response.data.traces.length; a++) {
                        for (let b = 0; b < hash_response.data.traces[a].inputs.length; b++) {
                            transaction_response.data.items[y].sirenDenormInputAddress.push(asset + ':' + hash_response.data.traces[a].inputs[b].address);
                        }
                        for (let c = 0; c < hash_response.data.traces[a].outputs.length; c++) {
                            transaction_response.data.items[y].sirenDenormOutputAddress.push(asset + ':' + hash_response.data.traces[a].outputs[c].address);
                        }
                    }
                }
                catch (error) { /* error handling can be done here if required */ }
            }
            overallResults.push.apply(overallResults, transaction_response.data.items);
        }
        return {
            transaction: overallResults,
            pagination: [{
                    totalresults: overallResults.length,
                    nextPage: overallNextPage
                }]
        };
    }
}
exports.default = AddressTransactions;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BZGRyZXNzVHJhbnNhY3Rpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsaUZBQStJO0FBQy9JLGlDQUFpRTtBQUVqRSxNQUFNLG1CQUFtQixHQUFHO0lBQ3hCLEtBQUssRUFBRSxzQ0FBc0M7SUFDN0MsS0FBSyxFQUFFLDZCQUE2QjtJQUNwQyxNQUFNLEVBQUUsNEJBQTRCO0lBQ3BDLEtBQUssRUFBRSx1QkFBdUI7SUFDOUIsS0FBSyxFQUFFLHNCQUFzQjtJQUM3QixLQUFLLEVBQUUsb0JBQW9CO0lBQzNCLEtBQUssRUFBRSwwQkFBMEI7SUFDakMsTUFBTSxFQUFFLG9CQUFvQjtJQUM1QixLQUFLLEVBQUUsb0JBQW9CO0lBQzNCLEtBQUssRUFBRSxnQ0FBZ0M7SUFDdkMsS0FBSyxFQUFFLG9CQUFvQjtJQUMzQixNQUFNLEVBQUUscUJBQXFCO0lBQzdCLEtBQUssRUFBRSxpQkFBaUI7SUFDeEIsS0FBSyxFQUFFLG9CQUFvQjtJQUMzQixNQUFNLEVBQUUsdUJBQXVCO0NBRWxDLENBQUM7QUFFRixNQUFxQixtQkFBb0IsU0FBUSx5Q0FBaUI7SUFBbEU7O1FBQ2EsU0FBSSxHQUFHLHNCQUFzQixDQUFDO1FBQzlCLGdCQUFXLEdBQWdCO1lBQ2hDLE9BQU8sRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRTtZQUN6QyxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUU7WUFDeEMsU0FBUyxFQUFFLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFO1lBQzVDLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRTtZQUN2QyxVQUFVLEVBQUUsRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUU7WUFDOUMsT0FBTyxFQUFFLEVBQUUsSUFBSSxF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QUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxHQUFHLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO3lCQUNqSTt3QkFDRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTs0QkFDbEUsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7eUJBQ25JO3FCQUNKO2lCQUNKO2dCQUFDLE9BQU8sS0FBSyxFQUFFLEVBQUUsaURBQWlELEVBQUU7YUFDeEU7WUFDRCxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLEVBQUUsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzlFO1FBRUQsT0FBTztZQUNILFdBQVcsRUFBRSxjQUFjO1lBQzNCLFVBQVUsRUFBRSxDQUFDO29CQUNULFlBQVksRUFBRSxjQUFjLENBQUMsTUFBTTtvQkFDbkMsUUFBUSxFQUFFLGVBQWU7aUJBQzVCLENBQUM7U0FDTCxDQUFDO0lBQ04sQ0FBQztDQUNKO0FBbEpELHNDQWtKQyIsImZpbGUiOiJzcmMvQWRkcmVzc1RyYW5zYWN0aW9ucy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFJbmRleFJlc3VsdHMsIElucHV0U2NoZW1hLCBPdXRwdXRDb25maWd1cmF0aW9uLCBTZXJ2aWNlRGVmaW5pdGlvbiwgV2ViU2VydmljZUVycm9yIH0gZnJvbSAnQHNpcmVuc29sdXRpb25zL3dlYi1zZXJ2aWNlLWludGVyZmFjZSc7XHJcbmltcG9ydCBheGlvcywgeyBBeGlvc1JlcXVlc3RDb25maWcsIEF4aW9zUmVzcG9uc2UgfSBmcm9tICdheGlvcyc7XHJcblxyXG5jb25zdCBjcnlwdG9SZWdleFBhdHRlcm5zID0ge1xyXG4gICAgJ0JUQyc6ICdeKGJjMXxbMTNdKVthLXpBLUhKLU5QLVowLTldezI1LDM5fSQnLCAvLyBCaXRjb2luIChCVEMpIGluY2x1ZGluZyBiZWNoMzIgYWRkcmVzc2VzXHJcbiAgICAnRVRIJzogJ14oPzoweCk/W2EtZkEtRjAtOV17NDAsNDJ9JCcsIC8vIEV0aGVyZXVtXHJcbiAgICAnVVNEVCc6ICdeMVsxLTldW2EtekEtWjAtOV17MjQsMzN9JCcsIC8vIFRldGhlclxyXG4gICAgJ1hSUCc6ICdeclswLTlhLXpBLVpdezI0LDM0fSQnLCAvLyBSaXBwbGVcclxuICAgICdCTkInOiAnXmJuYlswLTlhLXpBLVpdezM4fSQnLCAvLyBCaW5hbmNlIENvaW5cclxuICAgICdBREEnOiAnXkFlMnRkUHdVUEVZeXs0NH0kJywgLy8gQ2FyZGFub1xyXG4gICAgJ1NPTCc6ICdeU29bMS05XVswLTlhLXpBLVpdezQ4fSQnLCAvLyBTb2xhbmFcclxuICAgICdET0dFJzogJ15EWzAtOWEtZkEtRl17MzJ9JCcsIC8vIERvZ2Vjb2luXHJcbiAgICAnVFJYJzogJ15UWzAtOWEtZkEtRl17MzN9JCcsIC8vIFRyb25cclxuICAgICdMVEMnOiAnXkxbYS1rbS16QS1ISi1OUC1aMS05XXsyNiwzM30kJywgLy8gTGl0ZWNvaW5cclxuICAgICdET1QnOiAnXjFbYS16QS1aMC05XXszMX0kJywgLy8gUG9sa2Fkb3RcclxuICAgICdMSU5LJzogJ14weFthLWZBLUYwLTldezQwfSQnLCAvLyBDaGFpbmxpbmtcclxuICAgICdYTE0nOiAnXkdbQS1aMC05XXs1NX0kJywgLy8gU3RlbGxhciBMdW1lbnNcclxuICAgICdYTVInOiAnXjRbMC05QS1aYS16XXs5NH0kJywgLy8gTW9uZXJvXHJcbiAgICAnQVRPTSc6ICdeY29zbW9zMVthLXowLTldezM4fSQnLCAvLyBDb3Ntb3NcclxuICAgIC8vIEFkZCBtb3JlIHBhdHRlcm5zIGhlcmUgZm9yIG90aGVyIGNyeXB0b2N1cnJlbmNpZXNcclxufTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEFkZHJlc3NUcmFuc2FjdGlvbnMgZXh0ZW5kcyBTZXJ2aWNlRGVmaW5pdGlvbiB7XHJcbiAgICByZWFkb25seSBuYW1lID0gJ2FkZHJlc3NfdHJhbnNhY3Rpb25zJztcclxuICAgIHJlYWRvbmx5IGlucHV0U2NoZW1hOiBJbnB1dFNjaGVtYSA9IHtcclxuICAgICAgICBhZGRyZXNzOiB7IHR5cGU6ICd0ZXh0JywgcmVxdWlyZWQ6IHRydWUgfSxcclxuICAgICAgICBhc3NldDogeyB0eXBlOiAndGV4dCcsIHJlcXVpcmVkOiBmYWxzZSB9LFxyXG4gICAgICAgIGRpcmVjdGlvbjogeyB0eXBlOiAndGV4dCcsIHJlcXVpcmVkOiBmYWxzZSB9LFxyXG4gICAgICAgIHBhZ2U6IHsgdHlwZTogJ3RleHQnLCByZXF1aXJlZDogZmFsc2UgfSxcclxuICAgICAgICBwYWdlX2xpbWl0OiB7IHR5cGU6ICdmbG9hdCcsIHJlcXVpcmVkOiBmYWxzZSB9LFxyXG4gICAgICAgIGNsdXN0ZXI6IHsgdHlwZTogJ3RleHQnLCByZXF1aXJlZDogZmFsc2UgfSxcclxuICAgICAgICBjbHVzdGVyX2NvdW50ZXJwYXJ0eTogeyB0eXBlOiAndGV4dCcsIHJlcXVpcmVkOiBmYWxzZSB9LFxyXG4gICAgICAgIGNsdXN0ZXJfc3RhcnRUaW1lOiB7IHR5cGU6ICd0ZXh0JywgcmVxdWlyZWQ6IGZhbHNlIH0sXHJcbiAgICAgICAgY2x1c3Rlcl9lbmRUaW1lOiB7IHR5cGU6ICd0ZXh0JywgcmVxdWlyZWQ6IGZhbHNlIH0sXHJcbiAgICB9O1xyXG4gICAgcmVhZG9ubHkgb3V0cHV0Q29uZmlndXJhdGlvbjogT3V0cHV0Q29uZmlndXJhdGlvbiA9IHtcclxuICAgICAgICB0cmFuc2FjdGlvbjoge1xyXG4gICAgICAgICAgICBkZXRhaWxzOiB7XHJcbiAgICAgICAgICAgICAgICAnYmxvY2tUaW1lc3RhbXAnOiAnZGF0ZScsXHJcbiAgICAgICAgICAgICAgICAnYmxvY2tIZWlnaHQnOiAnbG9uZycsXHJcbiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlJzogJ2xvbmcnLFxyXG4gICAgICAgICAgICAgICAgJ2ZlZSc6ICdsb25nJyxcclxuICAgICAgICAgICAgICAgIHRyYWNlczoge1xyXG4gICAgICAgICAgICAgICAgICAgIGlucHV0czoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAnYW1vdW50JzogJ2xvbmcnXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBvdXRwdXRzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICdhbW91bnQnOiAnbG9uZydcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIHBhZ2luYXRpb246IHt9XHJcbiAgICB9O1xyXG5cclxuICAgIHByaXZhdGUgaW5mZXJBc3NldFR5cGUoYWRkcmVzczogc3RyaW5nKTogc3RyaW5nW10ge1xyXG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhjcnlwdG9SZWdleFBhdHRlcm5zKS5maWx0ZXIoYXNzZXQgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cChjcnlwdG9SZWdleFBhdHRlcm5zW2Fzc2V0XSkudGVzdChhZGRyZXNzKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBpbnZva2UoaW5wdXRzOiB7XHJcbiAgICAgICAgYWRkcmVzczogc3RyaW5nLFxyXG4gICAgICAgIGFzc2V0Pzogc3RyaW5nLFxyXG4gICAgICAgIGRpcmVjdGlvbjogc3RyaW5nLFxyXG4gICAgICAgIHBhZ2U/OiBzdHJpbmcsXHJcbiAgICAgICAgcGFnZV9saW1pdD86IG51bWJlcixcclxuICAgICAgICBjbHVzdGVyPzogc3RyaW5nLFxyXG4gICAgICAgIGNsdXN0ZXJfY291bnRlcnBhcnR5Pzogc3RyaW5nLFxyXG4gICAgICAgIGNsdXN0ZXJfc3RhcnRUaW1lPzogc3RyaW5nLFxyXG4gICAgICAgIGNsdXN0ZXJfZW5kVGltZT86IHN0cmluZ1xyXG4gICAgfSk6IFByb21pc2U8RGF0YUluZGV4UmVzdWx0cz4ge1xyXG4gICAgICAgIGNvbnN0IG1hdGNoZWRBc3NldHMgPSBpbnB1dHMuYXNzZXQgPyBbaW5wdXRzLmFzc2V0XSA6IHRoaXMuaW5mZXJBc3NldFR5cGUoaW5wdXRzLmFkZHJlc3MpO1xyXG4gICAgICAgIGxldCBvdmVyYWxsUmVzdWx0cyA9IFtdO1xyXG4gICAgICAgIGxldCBvdmVyYWxsTmV4dFBhZ2UgPSAnJztcclxuICAgICAgICBsZXQgb3ZlcmFsbFRydW5jYXRlZCA9IGZhbHNlO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IGFzc2V0IG9mIG1hdGNoZWRBc3NldHMpIHtcclxuICAgICAgICAgICAgbGV0IGJhc2VfdXJsID0gaW5wdXRzLmNsdXN0ZXIgXHJcbiAgICAgICAgICAgICAgICA/IGBodHRwczovL2lhcGkuY2hhaW5hbHlzaXMuY29tL2NsdXN0ZXJzLyR7aW5wdXRzLmFkZHJlc3N9LyR7YXNzZXR9L3RyYW5zYWN0aW9ucz9zaXplPTEwMGBcclxuICAgICAgICAgICAgICAgIDogYGh0dHBzOi8vaWFwaS5jaGFpbmFseXNpcy5jb20vYWRkcmVzc2VzLyR7aW5wdXRzLmFkZHJlc3N9LyR7YXNzZXR9L3RyYW5zYWN0aW9ucz9zaXplPTEwMCZkaXJlY3Rpb249JHtpbnB1dHMuZGlyZWN0aW9ufWA7XHJcbiAgICAgICAgICAgIGlmIChpbnB1dHMuY2x1c3Rlcl9zdGFydFRpbWUpIHtiYXNlX3VybCA9IGJhc2VfdXJsICsgYCZzdGFydFRpbWU9JHtpbnB1dHMuY2x1c3Rlcl9zdGFydFRpbWV9YCB9XHJcbiAgICAgICAgICAgIGlmIChpbnB1dHMuY2x1c3Rlcl9lbmRUaW1lKSB7IGJhc2VfdXJsID0gYmFzZV91cmwgKyBgJmVuZFRpbWU9JHtpbnB1dHMuY2x1c3Rlcl9lbmRUaW1lfWAgfVxyXG4gICAgICAgICAgICBpZiAoaW5wdXRzLmNsdXN0ZXJfY291bnRlcnBhcnR5KSB7IGJhc2VfdXJsID0gYmFzZV91cmwgKyBgJmNvdW50ZXJwYXJ0eT0ke2lucHV0cy5jbHVzdGVyX2NvdW50ZXJwYXJ0eX1gIH1cclxuXHJcbiAgICAgICAgICAgIGxldCB0cmFuc2FjdGlvbl91cmwgPSBgJHtiYXNlX3VybH1gXHJcbiAgICAgICAgICAgIGlmIChpbnB1dHMucGFnZSkge1xyXG4gICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25fdXJsID0gdHJhbnNhY3Rpb25fdXJsICsgYCZwYWdlPSR7aW5wdXRzLnBhZ2V9YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgcGFnZXNGZXRjaGVkID0gMDtcclxuICAgICAgICAgICAgY29uc3QgcGFnZUxpbWl0ID0gaW5wdXRzLnBhZ2VfbGltaXQgPyAoaW5wdXRzLnBhZ2VfbGltaXQgPT09IDAgPyBOdW1iZXIuTUFYX1NBRkVfSU5URUdFUiA6IGlucHV0cy5wYWdlX2xpbWl0KSA6IE51bWJlci5NQVhfU0FGRV9JTlRFR0VSO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgdHJhbnNhY3Rpb25fY29uZmlnOiBBeGlvc1JlcXVlc3RDb25maWcgPSB7XHJcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdnZXQnLFxyXG4gICAgICAgICAgICAgICAgdXJsOiB0cmFuc2FjdGlvbl91cmwsXHJcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgICAgICAgICAgICAgICAndG9rZW4nOiB0aGlzLmNvbmZpZy50b2tlblxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjb25zdCB0cmFuc2FjdGlvbl9yZXNwb25zZTogQXhpb3NSZXNwb25zZSA9IGF3YWl0IGF4aW9zKHRyYW5zYWN0aW9uX2NvbmZpZykuY2F0Y2goZXJyID0+IFByb21pc2UucmVqZWN0KGVyci5yZXNwb25zZSAmJiBlcnIucmVzcG9uc2Uuc3RhdHVzIDwgNTAwID8gbmV3IFdlYlNlcnZpY2VFcnJvcihlcnIucmVzcG9uc2UuZGF0YSkgOiBlcnIpKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0cmFuc2FjdGlvbl9yZXNwb25zZS5kYXRhLm5leHRQYWdlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIGxldCBwYWdlID0gdHJhbnNhY3Rpb25fcmVzcG9uc2UuZGF0YS5uZXh0UGFnZTtcclxuICAgICAgICAgICAgICAgIGxldCBsYXN0UmVzdWx0ID0geyBuZXh0UGFnZTogJycgfTtcclxuICAgICAgICAgICAgICAgIGRvIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgc3ViX3VybCA9IGAke2Jhc2VfdXJsfWAgKyBgJnBhZ2U9JHtwYWdlfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ViX2NvbmZpZzogQXhpb3NSZXF1ZXN0Q29uZmlnID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICdnZXQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHN1Yl91cmwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndG9rZW4nOiB0aGlzLmNvbmZpZy50b2tlblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdWJfcmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UgPSBhd2FpdCBheGlvcyhzdWJfY29uZmlnKS5jYXRjaChlcnIgPT4gUHJvbWlzZS5yZWplY3QoZXJyLnJlc3BvbnNlICYmIGVyci5yZXNwb25zZS5zdGF0dXMgPCA1MDAgPyBuZXcgV2ViU2VydmljZUVycm9yKGVyci5yZXNwb25zZS5kYXRhKSA6IGVycikpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxhc3RSZXN1bHQgPSBzdWJfcmVzcG9uc2UuZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbl9yZXNwb25zZS5kYXRhLml0ZW1zLnB1c2guYXBwbHkodHJhbnNhY3Rpb25fcmVzcG9uc2UuZGF0YS5pdGVtcywgc3ViX3Jlc3BvbnNlLmRhdGEuaXRlbXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2UgPSBsYXN0UmVzdWx0Lm5leHRQYWdlO1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VzRmV0Y2hlZCArPSAxO1xyXG4gICAgICAgICAgICAgICAgfSB3aGlsZSAobGFzdFJlc3VsdC5uZXh0UGFnZSAhPT0gbnVsbCAmJiBwYWdlc0ZldGNoZWQgPCBwYWdlTGltaXQpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGxhc3RSZXN1bHQubmV4dFBhZ2UgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICBvdmVyYWxsVHJ1bmNhdGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBvdmVyYWxsTmV4dFBhZ2UgPSBsYXN0UmVzdWx0Lm5leHRQYWdlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IHRyYW5zYWN0aW9uX3Jlc3BvbnNlLmRhdGEuaXRlbXMubGVuZ3RoOyB5KyspIHtcclxuICAgICAgICAgICAgICAgIGxldCBoYXNoX3VybCA9IGBodHRwczovL2lhcGkuY2hhaW5hbHlzaXMuY29tL3RyYW5zYWN0aW9ucy8ke3RyYW5zYWN0aW9uX3Jlc3BvbnNlLmRhdGEuaXRlbXNbeV0udHJhbnNhY3Rpb25IYXNofS8ke2Fzc2V0fS9kZXRhaWxzYDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGhhc2hfY29uZmlnOiBBeGlvc1JlcXVlc3RDb25maWcgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnZ2V0JyxcclxuICAgICAgICAgICAgICAgICAgICB1cmw6IGhhc2hfdXJsLFxyXG4gICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgJ3Rva2VuJzogdGhpcy5jb25maWcudG9rZW5cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaGFzaF9yZXNwb25zZTogQXhpb3NSZXNwb25zZSA9IGF3YWl0IGF4aW9zKGhhc2hfY29uZmlnKS5jYXRjaChlcnIgPT4gUHJvbWlzZS5yZWplY3QoZXJyLnJlc3BvbnNlICYmIGVyci5yZXNwb25zZS5zdGF0dXMgPCA1MDAgPyBuZXcgV2ViU2VydmljZUVycm9yKGVyci5yZXNwb25zZS5kYXRhKSA6IGVycikpO1xyXG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0cmFuc2FjdGlvbl9yZXNwb25zZS5kYXRhLml0ZW1zW3ldLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsczogaGFzaF9yZXNwb25zZS5kYXRhLFxyXG4gICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbjogaW5wdXRzLmRpcmVjdGlvbixcclxuICAgICAgICAgICAgICAgICAgICBpZDogYXNzZXQgKyAnOicgKyB0cmFuc2FjdGlvbl9yZXNwb25zZS5kYXRhLml0ZW1zW3ldLnRyYW5zYWN0aW9uSGFzaCxcclxuICAgICAgICAgICAgICAgICAgICBzaXJlbkRlbm9ybUlucHV0QWRkcmVzczogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgc2lyZW5EZW5vcm1PdXRwdXRBZGRyZXNzOiBbXVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBhID0gMDsgYSA8IGhhc2hfcmVzcG9uc2UuZGF0YS50cmFjZXMubGVuZ3RoOyBhKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgYiA9IDA7IGIgPCBoYXNoX3Jlc3BvbnNlLmRhdGEudHJhY2VzW2FdLmlucHV0cy5sZW5ndGg7IGIrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25fcmVzcG9uc2UuZGF0YS5pdGVtc1t5XS5zaXJlbkRlbm9ybUlucHV0QWRkcmVzcy5wdXNoKGFzc2V0ICsgJzonICsgaGFzaF9yZXNwb25zZS5kYXRhLnRyYWNlc1thXS5pbnB1dHNbYl0uYWRkcmVzcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgYyA9IDA7IGMgPCBoYXNoX3Jlc3BvbnNlLmRhdGEudHJhY2VzW2FdLm91dHB1dHMubGVuZ3RoOyBjKyspIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uX3Jlc3BvbnNlLmRhdGEuaXRlbXNbeV0uc2lyZW5EZW5vcm1PdXRwdXRBZGRyZXNzLnB1c2goYXNzZXQgKyAnOicgKyBoYXNoX3Jlc3BvbnNlLmRhdGEudHJhY2VzW2FdLm91dHB1dHNbY10uYWRkcmVzcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgeyAvKiBlcnJvciBoYW5kbGluZyBjYW4gYmUgZG9uZSBoZXJlIGlmIHJlcXVpcmVkICovIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvdmVyYWxsUmVzdWx0cy5wdXNoLmFwcGx5KG92ZXJhbGxSZXN1bHRzLCB0cmFuc2FjdGlvbl9yZXNwb25zZS5kYXRhLml0ZW1zKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHRyYW5zYWN0aW9uOiBvdmVyYWxsUmVzdWx0cyxcclxuICAgICAgICAgICAgcGFnaW5hdGlvbjogW3tcclxuICAgICAgICAgICAgICAgIHRvdGFscmVzdWx0czogb3ZlcmFsbFJlc3VsdHMubGVuZ3RoLFxyXG4gICAgICAgICAgICAgICAgbmV4dFBhZ2U6IG92ZXJhbGxOZXh0UGFnZVxyXG4gICAgICAgICAgICB9XVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbn1cclxuIl19
