"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const web_service_interface_1 = require("@sirensolutions/web-service-interface");
const axios_1 = require("axios");
class IpObservations extends web_service_interface_1.ServiceDefinition {
    constructor() {
        super(...arguments);
        this.name = 'ip_observations';
        this.inputSchema = {
            ip: { type: 'text', required: true },
            startTime: { type: 'date', required: false },
            endTime: { type: 'date', required: false },
            page: { type: 'date', required: false },
        };
        this.outputConfiguration = {
            observation: {
                'lat': 'long',
                'long': 'long',
                'timestamp': 'date',
                'geo_location': 'geo_point',
                'ipAddress': 'keyword',
                'port': 'keyword'
            },
            pagination: {
                'nextPage': 'keyword'
            }
        };
    }
    async invoke(inputs) {
        let obs_url = `https://iapi.chainalysis.com/observations/ips/${inputs.ip}?size=100`;
        if (inputs.page) {
            obs_url + obs_url + `&page=${inputs.page}`;
        }
        if (inputs.startTime) {
            obs_url = obs_url + `&startTime=${inputs.startTime}`;
        }
        if (inputs.endTime) {
            obs_url = obs_url + `&endTime=${inputs.endTime}`;
        }
        const obs_config = {
            method: 'get',
            url: obs_url,
            headers: {
                'Accept': 'application/json',
                'token': this.config.token
            }
        };
        const obs_response = await axios_1.default(obs_config).catch(err => Promise.reject(err.response && err.response.status < 500 ? new web_service_interface_1.WebServiceError(err.response.data) : err));
        let truncated = false;
        let nextPage = '';
        if (obs_response.data.nextPage != null) {
            let page = obs_response.data.nextPage;
            let lastResult = { nextPage: '' };
            do {
                try {
                    let sub_url = `https://iapi.chainalysis.com/observations/ips/${inputs.ip}?size=100` + `&page=${page}`;
                    const sub_config = {
                        method: 'get',
                        url: sub_url,
                        headers: {
                            'Accept': 'application/json',
                            'token': this.config.token
                        }
                    };
                    const sub_response = await axios_1.default(sub_config).catch(err => Promise.reject(err.response && err.response.status < 500 ? new web_service_interface_1.WebServiceError(err.response.data) : err));
                    lastResult = sub_response.data;
                    obs_response.data.items.push.apply(obs_response.data.items, sub_response.data.items);
                }
                catch {
                    new web_service_interface_1.WebServiceError('pagination error');
                }
            } while (lastResult.nextPage !== null && obs_response.data.items.length <= 400);
            if (lastResult.nextPage !== null || lastResult.nextPage !== '') {
                truncated = true;
                nextPage = lastResult.nextPage;
            }
        }
        for (let y = 0; y < obs_response.data.items.length; y++) {
            let plain_asset = obs_response.data.items[y].software.match(/bitcoin|ethereum/);
            let asset = '';
            if (plain_asset == 'bitcoin') {
                asset = 'BTC';
            }
            if (plain_asset == 'ethereum') {
                asset = 'ETH';
            }
            let denormAddress = [];
            denormAddress.push(`${asset}:${obs_response.data.items[y].walletRootAddress}`);
            denormAddress.push(`${asset}:${obs_response.data.items[y].rootAddress}`);
            Object.assign(obs_response.data.items[y], {
                sirenDenormAddress: ([...new Set(denormAddress)]),
                id: obs_response.data.items[y].ipAddress + ':' + obs_response.data.items[y].timestamp,
                address: obs_response.data.items[y].walletRootAddress,
                rootAddress: obs_response.data.rootAddress,
                geo_location: obs_response.data.items[y].lat + ',' + obs_response.data.items[y].long
            });
        }
        return {
            observation: obs_response.data.items,
            pagination: [{
                    nextPage: nextPage
                }]
        };
    }
}
exports.default = IpObservations;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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SSxDQUFDLFdBQVc7Z0JBQzFDLFlBQVksRUFBRSxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUk7YUFDdkYsQ0FBQyxDQUFBO1NBQ0w7UUFDRCxPQUFPO1lBQ0gsV0FBVyxFQUFFLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSztZQUNwQyxVQUFVLEVBQUUsQ0FBQztvQkFDVCxRQUFRLEVBQUUsUUFBUTtpQkFDckIsQ0FBQztTQUNMLENBQUE7SUFDTCxDQUFDO0NBQ0o7QUEvRkQsaUNBK0ZDIiwiZmlsZSI6InNyYy9JcE9ic2VydmF0aW9ucy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFJbmRleFJlc3VsdHMsIElucHV0U2NoZW1hLCBPdXRwdXRDb25maWd1cmF0aW9uLCBTZXJ2aWNlRGVmaW5pdGlvbiwgV2ViU2VydmljZUVycm9yIH0gZnJvbSAnQHNpcmVuc29sdXRpb25zL3dlYi1zZXJ2aWNlLWludGVyZmFjZSc7XHJcbmltcG9ydCBheGlvcywgeyBBeGlvc1JlcXVlc3RDb25maWcsIEF4aW9zUmVzcG9uc2UgfSBmcm9tICdheGlvcyc7XHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIElwT2JzZXJ2YXRpb25zIGV4dGVuZHMgU2VydmljZURlZmluaXRpb24ge1xyXG4gICAgcmVhZG9ubHkgbmFtZSA9ICdpcF9vYnNlcnZhdGlvbnMnO1xyXG4gICAgcmVhZG9ubHkgaW5wdXRTY2hlbWE6IElucHV0U2NoZW1hID0ge1xyXG4gICAgICAgIGlwOiB7IHR5cGU6ICd0ZXh0JywgcmVxdWlyZWQ6IHRydWUgfSxcclxuICAgICAgICBzdGFydFRpbWU6IHsgdHlwZTogJ2RhdGUnLCByZXF1aXJlZDogZmFsc2UgfSxcclxuICAgICAgICBlbmRUaW1lOiB7IHR5cGU6ICdkYXRlJywgcmVxdWlyZWQ6IGZhbHNlIH0sXHJcbiAgICAgICAgcGFnZTogeyB0eXBlOiAnZGF0ZScsIHJlcXVpcmVkOiBmYWxzZSB9LFxyXG4gICAgfTtcclxuICAgIHJlYWRvbmx5IG91dHB1dENvbmZpZ3VyYXRpb246IE91dHB1dENvbmZpZ3VyYXRpb24gPSB7XHJcbiAgICAgICAgb2JzZXJ2YXRpb246IHtcclxuICAgICAgICAgICAgJ2xhdCcgOiAnbG9uZycsXHJcbiAgICAgICAgICAgICdsb25nJzogJ2xvbmcnLFxyXG4gICAgICAgICAgICAndGltZXN0YW1wJzogJ2RhdGUnLFxyXG4gICAgICAgICAgICAnZ2VvX2xvY2F0aW9uJzogJ2dlb19wb2ludCcsXHJcbiAgICAgICAgICAgICdpcEFkZHJlc3MnOiAna2V5d29yZCcsXHJcbiAgICAgICAgICAgICdwb3J0JzogJ2tleXdvcmQnXHJcbiAgICAgICAgfSxcclxuICAgICAgICBwYWdpbmF0aW9uOiB7XHJcbiAgICAgICAgICAgICduZXh0UGFnZSc6ICdrZXl3b3JkJ1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcbiAgICBhc3luYyBpbnZva2UoaW5wdXRzOiB7XHJcbiAgICAgICAgaXA6IHN0cmluZyxcclxuICAgICAgICBzdGFydFRpbWU6IHN0cmluZyxcclxuICAgICAgICBlbmRUaW1lOiBzdHJpbmcsXHJcbiAgICAgICAgcGFnZTogc3RyaW5nLFxyXG4gICAgfSk6IFByb21pc2U8RGF0YUluZGV4UmVzdWx0cz4ge1xyXG4gICAgICAgIGxldCBvYnNfdXJsID0gYGh0dHBzOi8vaWFwaS5jaGFpbmFseXNpcy5jb20vb2JzZXJ2YXRpb25zL2lwcy8ke2lucHV0cy5pcH0/c2l6ZT0xMDBgXHJcbiAgICAgICAgaWYgKGlucHV0cy5wYWdlKSB7XHJcbiAgICAgICAgICAgIG9ic191cmwgKyBvYnNfdXJsICsgYCZwYWdlPSR7aW5wdXRzLnBhZ2V9YFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIGlmIChpbnB1dHMuc3RhcnRUaW1lKSB7b2JzX3VybCA9IG9ic191cmwgKyBgJnN0YXJ0VGltZT0ke2lucHV0cy5zdGFydFRpbWV9YH1cclxuICAgICAgICBpZiAoaW5wdXRzLmVuZFRpbWUpIHtvYnNfdXJsID0gb2JzX3VybCArIGAmZW5kVGltZT0ke2lucHV0cy5lbmRUaW1lfWB9XHJcbiAgICAgICAgY29uc3Qgb2JzX2NvbmZpZzogQXhpb3NSZXF1ZXN0Q29uZmlnID0ge1xyXG4gICAgICAgICAgICBtZXRob2Q6ICdnZXQnLFxyXG4gICAgICAgICAgICB1cmw6IG9ic191cmwsXHJcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgICAgICAgICAndG9rZW4nOiB0aGlzLmNvbmZpZy50b2tlblxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCBvYnNfcmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UgPSBhd2FpdCBheGlvcyhvYnNfY29uZmlnKS5jYXRjaChlcnIgPT4gUHJvbWlzZS5yZWplY3QoZXJyLnJlc3BvbnNlICYmIGVyci5yZXNwb25zZS5zdGF0dXMgPCA1MDAgPyBuZXcgV2ViU2VydmljZUVycm9yKGVyci5yZXNwb25zZS5kYXRhKSA6IGVycikpO1xyXG4gICAgICAgIGxldCB0cnVuY2F0ZWQgPSBmYWxzZVxyXG4gICAgICAgIGxldCBuZXh0UGFnZSA9ICcnO1xyXG4gICAgICAgIGlmIChvYnNfcmVzcG9uc2UuZGF0YS5uZXh0UGFnZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGxldCBwYWdlID0gb2JzX3Jlc3BvbnNlLmRhdGEubmV4dFBhZ2VcclxuICAgICAgICAgICAgbGV0IGxhc3RSZXN1bHQgPSB7IG5leHRQYWdlOiAnJyB9O1xyXG4gICAgICAgICAgICBkbyB7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJfdXJsID0gYGh0dHBzOi8vaWFwaS5jaGFpbmFseXNpcy5jb20vb2JzZXJ2YXRpb25zL2lwcy8ke2lucHV0cy5pcH0/c2l6ZT0xMDBgICsgYCZwYWdlPSR7cGFnZX1gXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3ViX2NvbmZpZzogQXhpb3NSZXF1ZXN0Q29uZmlnID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6ICdnZXQnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHN1Yl91cmwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndG9rZW4nOiB0aGlzLmNvbmZpZy50b2tlblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdWJfcmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UgPSBhd2FpdCBheGlvcyhzdWJfY29uZmlnKS5jYXRjaChlcnIgPT4gUHJvbWlzZS5yZWplY3QoZXJyLnJlc3BvbnNlICYmIGVyci5yZXNwb25zZS5zdGF0dXMgPCA1MDAgPyBuZXcgV2ViU2VydmljZUVycm9yKGVyci5yZXNwb25zZS5kYXRhKSA6IGVycikpO1xyXG4gICAgICAgICAgICAgICAgICAgIGxhc3RSZXN1bHQgPSBzdWJfcmVzcG9uc2UuZGF0YTtcclxuICAgICAgICAgICAgICAgICAgICBvYnNfcmVzcG9uc2UuZGF0YS5pdGVtcy5wdXNoLmFwcGx5KG9ic19yZXNwb25zZS5kYXRhLml0ZW1zLCBzdWJfcmVzcG9uc2UuZGF0YS5pdGVtcylcclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggeyBuZXcgV2ViU2VydmljZUVycm9yKCdwYWdpbmF0aW9uIGVycm9yJykgfVxyXG4gICAgICAgICAgICB9IHdoaWxlIChsYXN0UmVzdWx0Lm5leHRQYWdlICE9PSBudWxsICYmIG9ic19yZXNwb25zZS5kYXRhLml0ZW1zLmxlbmd0aCA8PSA0MDApXHJcbiAgICAgICAgICAgIGlmIChsYXN0UmVzdWx0Lm5leHRQYWdlICE9PSBudWxsIHx8IGxhc3RSZXN1bHQubmV4dFBhZ2UgIT09ICcnKSB7XHJcbiAgICAgICAgICAgICAgICB0cnVuY2F0ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgbmV4dFBhZ2UgPSBsYXN0UmVzdWx0Lm5leHRQYWdlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgb2JzX3Jlc3BvbnNlLmRhdGEuaXRlbXMubGVuZ3RoOyB5KyspIHtcclxuICAgICAgICAgICAgbGV0IHBsYWluX2Fzc2V0ID0gb2JzX3Jlc3BvbnNlLmRhdGEuaXRlbXNbeV0uc29mdHdhcmUubWF0Y2goL2JpdGNvaW58ZXRoZXJldW0vKVxyXG4gICAgICAgICAgICBsZXQgYXNzZXQ6IFN0cmluZyA9ICcnXHJcbiAgICAgICAgICAgIGlmIChwbGFpbl9hc3NldCA9PSAnYml0Y29pbicpIHtcclxuICAgICAgICAgICAgICAgIGFzc2V0ID0gJ0JUQydcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAocGxhaW5fYXNzZXQgPT0gJ2V0aGVyZXVtJykge1xyXG4gICAgICAgICAgICAgICAgYXNzZXQgPSAnRVRIJ1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCBkZW5vcm1BZGRyZXNzOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgICAgICAgICBkZW5vcm1BZGRyZXNzLnB1c2goYCR7YXNzZXR9OiR7b2JzX3Jlc3BvbnNlLmRhdGEuaXRlbXNbeV0ud2FsbGV0Um9vdEFkZHJlc3N9YClcclxuICAgICAgICAgICAgZGVub3JtQWRkcmVzcy5wdXNoKGAke2Fzc2V0fToke29ic19yZXNwb25zZS5kYXRhLml0ZW1zW3ldLnJvb3RBZGRyZXNzfWApXHJcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24ob2JzX3Jlc3BvbnNlLmRhdGEuaXRlbXNbeV0sIHtcclxuICAgICAgICAgICAgICAgIHNpcmVuRGVub3JtQWRkcmVzczogKFsuLi4gbmV3IFNldChkZW5vcm1BZGRyZXNzKV0pLFxyXG4gICAgICAgICAgICAgICAgaWQ6IG9ic19yZXNwb25zZS5kYXRhLml0ZW1zW3ldLmlwQWRkcmVzcyArICc6JyArIG9ic19yZXNwb25zZS5kYXRhLml0ZW1zW3ldLnRpbWVzdGFtcCxcclxuICAgICAgICAgICAgICAgIGFkZHJlc3M6IG9ic19yZXNwb25zZS5kYXRhLml0ZW1zW3ldLndhbGxldFJvb3RBZGRyZXNzLFxyXG4gICAgICAgICAgICAgICAgcm9vdEFkZHJlc3M6IG9ic19yZXNwb25zZS5kYXRhLnJvb3RBZGRyZXNzLFxyXG4gICAgICAgICAgICAgICAgZ2VvX2xvY2F0aW9uOiBvYnNfcmVzcG9uc2UuZGF0YS5pdGVtc1t5XS5sYXQgKyAnLCcgKyBvYnNfcmVzcG9uc2UuZGF0YS5pdGVtc1t5XS5sb25nXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIG9ic2VydmF0aW9uOiBvYnNfcmVzcG9uc2UuZGF0YS5pdGVtcyxcclxuICAgICAgICAgICAgcGFnaW5hdGlvbjogW3tcclxuICAgICAgICAgICAgICAgIG5leHRQYWdlOiBuZXh0UGFnZVxyXG4gICAgICAgICAgICB9XVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=
